<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>🧹 Data Cleaning Notebook</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://jupyter.org/favicon.ico" />
    <style>
      html, body { height:100%; margin:0; }
      #lite { width:100%; height:100%; border:0; display:block; }
    </style>
  </head>
  <body>
    <iframe id="lite" title="JupyterLite"></iframe>

    <script>
      // 你的 Render 后端（保存参与者的 Notebook/结果）
      const backendURL = "https://notebook-mirror.onrender.com/upload";

      // 关键：给 JupyterLite 一个“可跨域访问的绝对 URL”
      const taskURL = window.location.origin + "/task.ipynb";
      const liteURL =
        "https://jupyterlite.github.io/demo/lab/index.html?path=" +
        encodeURIComponent(taskURL);

      // 挂载 JupyterLite
      const iframe = document.getElementById("lite");
      iframe.src = liteURL;

      // 简单的参与者 ID（按需替换成你的）
      const participantID = "user_" + Math.random().toString(36).slice(2, 8);

      // 监听 JupyterLite 的保存事件，并把 Notebook JSON 发到后端
      window.addEventListener("message", async (event) => {
        const data = event?.data;
        if (!data) return;
        if (data.type !== "notebookSaved" || !data.content) return;

        try {
          await fetch(backendURL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              participant_id: participantID,
              notebook_json: JSON.stringify(data.content),
            }),
          });
          console.log("✅ Auto-saved to backend");
        } catch (err) {
          console.error("❌ Save failed:", err);
        }
      });

      // 每 60 秒请求保存一次
      setInterval(() => {
        if (iframe?.contentWindow) {
          iframe.contentWindow.postMessage({ type: "saveNotebook" }, "*");
        }
      }, 60_000);
    </script>
  </body>
</html>
