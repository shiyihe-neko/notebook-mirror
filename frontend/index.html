<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>🧹 Data Cleaning Notebook</title>
    <link rel="icon" href="https://jupyter.org/favicon.ico" />
    <script src="https://unpkg.com/@jupyterlite/iframe-embed@0.4.0/dist/index.js"></script>
  </head>

  <body style="margin:0;padding:0;height:100vh;overflow:hidden;">
    <!-- ✅ 自动加载你放在同一目录下的 task.ipynb -->
    <iframe
      id="lite"
      src="https://jupyterlite.github.io/demo/lab/index.html?path=task.ipynb"
      style="width:100%;height:100%;border:none;"
    ></iframe>

    <script>
      // ✅ 你的后端（Render）地址：替换成你部署后得到的 URL
      const backendURL = "https://your-render-backend.onrender.com/upload";

      // ✅ 为每个用户生成唯一 ID
      const participantID = "user_" + Math.random().toString(36).substring(2, 8);

      // ✅ 监听 notebook 自动保存事件
      window.addEventListener("message", async (event) => {
        if (!event.data || !event.data.content) return;

        if (event.data.type === "notebookSaved") {
          const notebookJSON = JSON.stringify(event.data.content);
          try {
            await fetch(backendURL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                participant_id: participantID,
                notebook_json: notebookJSON,
              }),
            });
            console.log("✅ Notebook auto-saved to backend");
          } catch (err) {
            console.error("❌ Save failed:", err);
          }
        }
      });

      // ✅ 每 60 秒自动触发保存
      setInterval(() => {
        const iframe = document.getElementById("lite");
        if (iframe && iframe.contentWindow) {
          iframe.contentWindow.postMessage({ type: "saveNotebook" }, "*");
        }
      }, 60000);
    </script>
  </body>
</html>
