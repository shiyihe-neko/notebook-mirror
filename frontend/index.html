<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ðŸ§¹ Data Cleaning Notebook</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://jupyter.org/favicon.ico" />
    <style>
      html, body { height:100%; margin:0; }
      #lite { width:100%; height:100%; border:0; display:block; }
    </style>
  </head>
  <body>
    <iframe id="lite" title="JupyterLite"></iframe>

    <script>
      // Render åŽç«¯ï¼ˆå¦‚éœ€ï¼‰
      const backendURL = "https://notebook-mirror.onrender.com/upload";

      // âœ… ç”¨ new URL ç”Ÿæˆâ€œç»å¯¹ URLâ€ï¼Œé¿å…ç¼ºå°‘ // çš„é—®é¢˜
      const taskURL = new URL('/task.ipynb', window.location.href).toString();
      const liteURL = new URL(
        'https://jupyterlite.github.io/demo/lab/index.html'
      );
      liteURL.searchParams.set('path', taskURL);

      console.log('[Notebook URL]', taskURL);
      console.log('[Lite URL]', liteURL.toString());
      document.getElementById('lite').src = liteURL.toString();

      // å¯é€‰ï¼šè‡ªåŠ¨ä¿å­˜åˆ°åŽç«¯
      const participantID = 'user_' + Math.random().toString(36).slice(2, 8);
      window.addEventListener('message', async (event) => {
        const data = event?.data;
        if (!data || data.type !== 'notebookSaved' || !data.content) return;
        try {
          await fetch(backendURL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              participant_id: participantID,
              notebook_json: JSON.stringify(data.content),
            }),
          });
          console.log('âœ… Auto-saved to backend');
        } catch (err) {
          console.error('âŒ Save failed:', err);
        }
      });

      setInterval(() => {
        const ifr = document.getElementById('lite');
        if (ifr?.contentWindow) {
          ifr.contentWindow.postMessage({ type: 'saveNotebook' }, '*');
        }
      }, 60000);
    </script>
  </body>
</html>
