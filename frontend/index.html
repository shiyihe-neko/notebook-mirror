<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ðŸ§¹ Data Cleaning Notebook</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://jupyter.org/favicon.ico" />
    <style>
      html, body { height:100%; margin:0; }
      #lite { width:100%; height:100%; border:0; display:block; }
    </style>
  </head>
  <body>
    <iframe id="lite" title="JupyterLite"></iframe>

    <script>
      // ä½ çš„ Render åŽç«¯ï¼ˆä¿å­˜å‚ä¸Žè€…çš„ Notebook/ç»“æžœï¼‰
      const backendURL = "https://notebook-mirror.onrender.com/upload";

      // å…³é”®ï¼šç»™ JupyterLite ä¸€ä¸ªâ€œå¯è·¨åŸŸè®¿é—®çš„ç»å¯¹ URLâ€
      const taskURL = window.location.origin + "/task.ipynb";
      const liteURL =
        "https://jupyterlite.github.io/demo/lab/index.html?path=" +
        encodeURIComponent(taskURL);

      // æŒ‚è½½ JupyterLite
      const iframe = document.getElementById("lite");
      iframe.src = liteURL;

      // ç®€å•çš„å‚ä¸Žè€… IDï¼ˆæŒ‰éœ€æ›¿æ¢æˆä½ çš„ï¼‰
      const participantID = "user_" + Math.random().toString(36).slice(2, 8);

      // ç›‘å¬ JupyterLite çš„ä¿å­˜äº‹ä»¶ï¼Œå¹¶æŠŠ Notebook JSON å‘åˆ°åŽç«¯
      window.addEventListener("message", async (event) => {
        const data = event?.data;
        if (!data) return;
        if (data.type !== "notebookSaved" || !data.content) return;

        try {
          await fetch(backendURL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              participant_id: participantID,
              notebook_json: JSON.stringify(data.content),
            }),
          });
          console.log("âœ… Auto-saved to backend");
        } catch (err) {
          console.error("âŒ Save failed:", err);
        }
      });

      // æ¯ 60 ç§’è¯·æ±‚ä¿å­˜ä¸€æ¬¡
      setInterval(() => {
        if (iframe?.contentWindow) {
          iframe.contentWindow.postMessage({ type: "saveNotebook" }, "*");
        }
      }, 60_000);
    </script>
  </body>
</html>
