<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ðŸ§¹ Data Cleaning Notebook</title>
    <link rel="icon" href="https://jupyter.org/favicon.ico" />
    <script src="https://unpkg.com/@jupyterlite/iframe-embed@0.4.0/dist/index.js"></script>
  </head>

  <body style="margin:0;padding:0;height:100vh;overflow:hidden;">
    <!-- è‡ªåŠ¨ç”¨ JupyterLite æ‰“å¼€åŒç›®å½•çš„ task.ipynb -->
    <iframe
      id="lite"
      src="https://jupyterlite.github.io/demo/lab/index.html?path=task.ipynb"
      style="width:100%;height:100%;border:none;"
    ></iframe>

    <script>
      // â¬‡ï¸ éƒ¨ç½²åŽæŠŠä¸‹é¢è¿™ä¸ªæ¢æˆä½ çš„ Render åŽç«¯åœ°å€ï¼ˆæœ«å°¾å¸¦ /uploadï¼‰
      const backendURL = "https://notebook-mirror.onrender.com/upload";

      // ä¸ºæ¯ä¸ªè®¿é—®è€…ç”Ÿæˆä¸€ä¸ªåŒ¿å IDï¼ˆä¹Ÿå¯æ”¹æˆè¯»å– URL çš„ ?pid=xxxï¼‰
      const participantID = "user_" + Math.random().toString(36).slice(2, 8);

      // ç›‘å¬ JupyterLite çš„ã€Œä¿å­˜ã€äº‹ä»¶ï¼ŒæŠŠ .ipynb å‘åˆ°åŽç«¯æŒä¹…åŒ–
      window.addEventListener("message", async (event) => {
        if (!event?.data || !event.data.content) return;
        if (event.data.type !== "notebookSaved") return;

        const notebookJSON = JSON.stringify(event.data.content);
        try {
          await fetch(backendURL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              participant_id: participantID,
              notebook_json: notebookJSON,
            }),
          });
          console.log("âœ… Auto-saved to backend");
        } catch (err) {
          console.error("âŒ Save failed:", err);
        }
      });

      // æ¯ 60 ç§’è‡ªåŠ¨è§¦å‘ä¿å­˜ï¼ˆä¹Ÿå¯åŠ æŒ‰é’®æ‰‹åŠ¨æäº¤ï¼‰
      setInterval(() => {
        const ifr = document.getElementById("lite");
        if (ifr?.contentWindow) {
          ifr.contentWindow.postMessage({ type: "saveNotebook" }, "*");
        }
      }, 60000);
    </script>
  </body>
</html>
